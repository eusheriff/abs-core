
> @abs/core@2.7.0 test
> vitest run test/risk-scoring.test.ts


 RUN  v0.34.6 /Volumes/LexarAPFS/ABS/packages/core

stdout | unknown test
[PolicyRegistry] Registered policy for prefix 'whatsapp': WhatsAppBotPolicy
[PolicyRegistry] Registered policy for prefix 'bot': Unnamed

stdout | test/risk-scoring.test.ts > Risk Scoring Engine > Should escalate if score is 50+ (High Risk)
[PolicyRegistry] Registered policy for prefix 'finance.transfer': high-risk-rule
[PolicyRegistry] Loaded 1 dynamic rules.
ğŸ“¦ Initializing Local DB at /Volumes/LexarAPFS/ABS/packages/core/:memory:
{"timestamp":"2026-01-21T00:14:28.799Z","severity":"ERROR","message":"Event validation failed","trace_id":"1ee16370-c94d-4a4d-b826-fec9d00f5565","span_id":"6d1cef33-db34-4b","tenant_id":"t1","error":"[\n  {\n    \"validation\": \"uuid\",\n    \"code\": \"invalid_string\",\n    \"message\": \"Invalid uuid\",\n    \"path\": [\n      \"event_id\"\n    ]\n  },\n  {\n    \"code\": \"invalid_type\",\n    \"expected\": \"string\",\n    \"received\": \"undefined\",\n    \"path\": [\n      \"source\"\n    ],\n    \"message\": \"Required\"\n  },\n  {\n    \"code\": \"invalid_type\",\n    \"expected\": \"string\",\n    \"received\": \"undefined\",\n    \"path\": [\n      \"correlation_id\"\n    ],\n    \"message\": \"Required\"\n  }\n]","signature":"40f48d6fcbbe54eca3bdf6db51a7576738f9ae06561e1763a49d038441b01813"}

stdout | test/risk-scoring.test.ts > Risk Scoring Engine > Should deny if score is 80+ (Critical Risk)
[PolicyRegistry] Registered policy for prefix 'security.login': critical-risk-rule
[PolicyRegistry] Loaded 1 dynamic rules.
ğŸ“¦ Initializing Local DB at /Volumes/LexarAPFS/ABS/packages/core/:memory:

stdout | test/risk-scoring.test.ts > Risk Scoring Engine > Should deny if score is 80+ (Critical Risk)
{"timestamp":"2026-01-21T00:14:28.803Z","severity":"ERROR","message":"Event validation failed","trace_id":"33c3cc23-ade4-4663-8f04-dc56a73291bc","span_id":"d9451121-6703-4e","tenant_id":"t1","error":"[\n  {\n    \"validation\": \"uuid\",\n    \"code\": \"invalid_string\",\n    \"message\": \"Invalid uuid\",\n    \"path\": [\n      \"event_id\"\n    ]\n  },\n  {\n    \"code\": \"invalid_type\",\n    \"expected\": \"string\",\n    \"received\": \"undefined\",\n    \"path\": [\n      \"source\"\n    ],\n    \"message\": \"Required\"\n  },\n  {\n    \"code\": \"invalid_type\",\n    \"expected\": \"string\",\n    \"received\": \"undefined\",\n    \"path\": [\n      \"correlation_id\"\n    ],\n    \"message\": \"Required\"\n  }\n]","signature":"48e84dce14715476ef9bf3707b45f60d4db976d451a75fabdc0857c36cad778f"}

 â¯ test/risk-scoring.test.ts  (2 tests | 1 failed) 19ms
   â¯ test/risk-scoring.test.ts > Risk Scoring Engine > Should escalate if score is 50+ (High Risk)
     â†’ expected 'DENY' to be 'ESCALATE' // Object.is equality

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 1 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/risk-scoring.test.ts > Risk Scoring Engine > Should escalate if score is 50+ (High Risk)
AssertionError: expected 'DENY' to be 'ESCALATE' // Object.is equality

- Expected
+ Received

- ESCALATE
+ DENY

 â¯ test/risk-scoring.test.ts:33:33
     31|         });
     32| 
     33|         expect(result.decision).toBe('ESCALATE'); // Overridden from Aâ€¦
       |                                 ^
     34|         expect(result.status).toBe('pending_review');
     35|     });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯

 Test Files  1 failed (1)
      Tests  1 failed | 1 passed (2)
   Start at  21:14:28
   Duration  451ms (transform 107ms, setup 0ms, collect 127ms, tests 19ms, environment 0ms, prepare 65ms)

npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /Volumes/LexarAPFS/ABS/packages/core
npm error workspace @abs/core@2.7.0
npm error location /Volumes/LexarAPFS/ABS/packages/core
npm error command failed
npm error command sh -c vitest run test/risk-scoring.test.ts
